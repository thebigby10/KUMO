// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}


model User {
  id              String   @id @default(uuid())
  email           String   @unique
  name            String?
  password        String?  // Optional for Google Users
  avatar          String?  // New from ERD
  googleId        String?  // New from ERD
  isEmailVerified Boolean  @default(false) // New from ERD
  provider        String   @default("email") // New from ERD
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  enrollments     Enrollment[]
  instructing     Instructor[]
  announcements   Announcement[]

  @@map("users")
}

// --- 2. CLASSROOM MANAGEMENT (New from ERD) ---
model Lab {
  id          String   @id @default(uuid())
  name        String
  section     String?
  subject     String?
  room        String?
  banner      String?  // URL to banner image
  description String?
  labCode     String   @unique // The code students use to join
  isArchived  Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  enrollments Enrollment[]
  instructors Instructor[]
  labWorks    LabWork[]
  announcements Announcement[]

  @@map("labs")
}

// Junction table: Students in a Lab
model Enrollment {
  id        String   @id @default(uuid())
  userEmail String
  labId     String
  joinedAt  DateTime @default(now())

  user User @relation(fields: [userEmail], references: [email])
  lab  Lab  @relation(fields: [labId], references: [id])

  @@unique([userEmail, labId]) // Prevent double joining
  @@map("enrollments")
}

// Junction table: Teachers in a Lab
model Instructor {
  id        String   @id @default(uuid())
  labId     String
  userEmail String
  role      Role     @default(ASSISTANT) // OWNER or ASSISTANT

  lab  Lab  @relation(fields: [labId], references: [id])
  user User @relation(fields: [userEmail], references: [email])

  @@unique([labId, userEmail])
  @@map("instructors")
}

// --- 3. COMMUNICATION (Stream) ---
model Announcement {
  id        String   @id @default(uuid())
  labId     String
  content   String   
  postedBy  String   
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  lab  Lab  @relation(fields: [labId], references: [id])
  user User @relation(fields: [postedBy], references: [email])
  
  materials AnnouncementMaterial[]

  @@map("announcements")
}

model AnnouncementMaterial {
  id             String @id @default(uuid())
  title          String
  url            String
  description    String?
  announcementId String
  
  announcement Announcement @relation(fields: [announcementId], references: [id])

  @@map("announcement_materials")
}

// --- 4. COURSEWORK (Assignments) ---
model LabWork {
  id          String   @id @default(uuid())
  labId       String
  title       String
  description String?
  totalPoints Int      @default(100)
  startTime   DateTime?
  endTime     DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  lab       Lab          @relation(fields: [labId], references: [id])
  tasks     LabTask[]
  materials LabMaterial[]

  @@map("lab_works")
}

model LabTask {
  id          String   @id @default(uuid())
  labWorkId   String
  title       String
  description String?
  url         String?  // Piston/execution config url?
  point       Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  labWork   LabWork      @relation(fields: [labWorkId], references: [id])
  materials TaskMaterial[]
  testCases TestCase[]
  editors   Editor[]
  hints     Hint[]

  @@map("lab_tasks")
}

// --- 5. SUPPORTING TABLES ---
model LabMaterial {
  id          String @id @default(uuid())
  labWorkId   String
  title       String?
  description String?
  url         String

  labWork LabWork @relation(fields: [labWorkId], references: [id])
  @@map("lab_materials")
}

model TaskMaterial {
  id          String @id @default(uuid())
  taskId      String
  title       String?
  description String?
  url         String?

  task LabTask @relation(fields: [taskId], references: [id])
  @@map("task_materials")
}

model TestCase {
  id           String @id @default(uuid())
  taskId       String
  input        String
  expectOutput String

  task LabTask @relation(fields: [taskId], references: [id])
  @@map("test_cases")
}

model Editor {
  id          String @id @default(uuid())
  taskId      String
  solution    String // Starter code or solution
  description String?
  url         String?

  task LabTask @relation(fields: [taskId], references: [id])
  @@map("editors")
}

model Hint {
  id     String @id @default(uuid())
  taskId String
  hint   String

  task LabTask @relation(fields: [taskId], references: [id])
  @@map("hints")
}

enum Role {
  OWNER
  ASSISTANT
}